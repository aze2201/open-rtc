<!DOCTYPE html>
<html>
<head>
    <title>VR WebRTC AR</title>
    <style>
        /* VR split-screen layout */
        .vr-container {
            display: flex;
            width: 100vw;
            height: 100vh;
        }
        .eye-view {
            flex: 1;
            overflow: hidden;
        }
        /* Print styling */
        @media print {
            .vr-container { flex-direction: column; }
            .eye-view { height: 50vh !important; }
        }
    </style>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="vr-container">
        <!-- Left Eye View -->
        <div class="eye-view">
            <a-scene embedded>
                <a-box id="left-box" position="0 1.6 -5" width="3" height="3"></a-box>
                <a-camera position="-0.1 1.6 0"></a-camera>
            </a-scene>
        </div>

        <!-- Right Eye View -->
        <div class="eye-view">
            <a-scene embedded>
                <a-box id="right-box" position="0 1.6 -5" width="3" height="3"></a-box>
                <a-camera position="0.1 1.6 0"></a-camera>
            </a-scene>
        </div>
    </div>

    <script>
        // Initialize PeerJS connection
        const peer = new Peer();
        let connection;

        // Update both VR boxes simultaneously
        function updateBoxSizes(width, height, depth) {
            document.querySelectorAll('[id$="-box"]').forEach(box => {
                box.setAttribute('width', width);
                box.setAttribute('height', height);
                box.setAttribute('depth', depth);
                box.setAttribute('position', `0 1.6 -${depth}`);
            });
        }

        peer.on('open', peerId => {
            const urlParams = new URLSearchParams(window.location.search);
            const remoteId = urlParams.get('PeerDesktopID');

            if (remoteId) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        const call = peer.call(remoteId, stream);
                        connection = peer.connect(remoteId);

                        connection.on('data', data => {
                            const [width, height, depth] = data.split(',').map(Number);
                            if (!isNaN(width)) updateBoxSizes(width, height, depth);
                        });

                        call.on('stream', remoteStream => {
                            document.querySelectorAll('a-box').forEach(box => {
                                box.setAttribute('material', 'src', URL.createObjectURL(remoteStream));
                            });
                        });
                    });
            }
        });
    </script>
</body>
</html>
