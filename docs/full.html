<!DOCTYPE html>
<html>
<head>
    <title>VR WebRTC AR (Duplicated)</title>
    <style>
        /* VR split-screen styling */
        .vr-container {
            display: flex;
            width: 200vw; /* Double the width */
            height: 100vh;
            position: relative;
        }
        .eye-view {
            flex: 1;
            overflow: hidden;
            position: relative;
            width: 50vw; /* Each view takes half the viewport width */
        }
        .video-background {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        .webrtc-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1; /* Ensure it's above the A-Scene */
        }
        .webrtc-video {
            width: 320px; /* Initial size */
            height: 240px; /* Initial size */
        }
        /* Print styling */
        @media print {
            .vr-container { flex-direction: column; }
            .eye-view { height: 50vh !important; width: 100vw; }
        }
    </style>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="vr-container">
        <div class="eye-view">
            <video class="video-background" id="left-video" autoplay playsinline muted></video>
            <a-scene embedded>
                <a-box id="left-box" position="0 1.6 -5" width="3" height="3"></a-box>
                <a-camera position="-0.1 1.6 0"></a-camera>
                <a-sky color="#ECECEC"></a-sky>
            </a-scene>
            <div class="webrtc-container left-webrtc">
                <video id="localVideoLeft" class="webrtc-video" autoplay playsinline muted></video>
                <video id="remoteVideoLeft" class="webrtc-video" autoplay playsinline></video>
            </div>
        </div>

        <div class="eye-view">
            <video class="video-background" id="right-video" autoplay playsinline muted></video>
            <a-scene embedded>
                <a-box id="right-box" position="0 1.6 -5" width="3" height="3"></a-box>
                <a-camera position="0.1 1.6 0"></a-camera>
                <a-sky color="#ECECEC"></a-sky>
            </a-scene>
            <div class="webrtc-container right-webrtc">
                <video id="localVideoRight" class="webrtc-video" autoplay playsinline muted></video>
                <video id="remoteVideoRight" class="webrtc-video" autoplay playsinline></video>
            </div>
        </div>
    </div>

    <script>
        const peer = new Peer();
        let connection;
        let localStream;

        const localVideoLeft = document.getElementById('localVideoLeft');
        const remoteVideoLeft = document.getElementById('remoteVideoLeft');
        const localVideoRight = document.getElementById('localVideoRight');
        const remoteVideoRight = document.getElementById('remoteVideoRight');
        const webrtcVideos = document.querySelectorAll('.webrtc-video');
        const leftBox = document.getElementById('left-box');
        const rightBox = document.getElementById('right-box');
        const leftVideoBackground = document.getElementById('left-video');
        const rightVideoBackground = document.getElementById('right-video');

        function setVideoStream(element, stream) {
            element.srcObject = stream;
        }

        function updateSizes(width, height, depth) {
            leftBox.setAttribute('width', width);
            leftBox.setAttribute('height', height);
            leftBox.setAttribute('depth', depth / 2);
            leftBox.setAttribute('position', `0 1.6 -${depth}`);

            rightBox.setAttribute('width', width);
            rightBox.setAttribute('height', height);
            rightBox.setAttribute('depth', depth / 2);
            rightBox.setAttribute('position', `0 1.6 -${depth}`);

            leftVideoBackground.style.transform = `scale(${depth / 5})`;
            rightVideoBackground.style.transform = `scale(${depth / 5})`;
        }

        function updateWebRTCSize(width, height) {
            webrtcVideos.forEach(video => {
                video.style.width = `${width}px`;
                video.style.height = `${height}px`;
            });
        }

        peer.on('open', peerId => {
            const urlParams = new URLSearchParams(window.location.search);
            const remoteId = urlParams.get('PeerDesktopID');

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localStream = stream;
                    setVideoStream(localVideoLeft, stream);
                    setVideoStream(localVideoRight, stream);
                    leftVideoBackground.srcObject = stream;
                    rightVideoBackground.srcObject = stream;

                    if (remoteId) {
                        const call = peer.call(remoteId, stream);
                        connection = peer.connect(remoteId);

                        connection.on('data', data => {
                            const [width, height, depth] = data.split(',').map(Number);
                            if (!isNaN(width)) updateSizes(width, height, depth);
                        });

                        call.on('stream', remoteStream => {
                            setVideoStream(remoteVideoLeft, remoteStream);
                            setVideoStream(remoteVideoRight, remoteStream);
                            leftBox.setAttribute('material', 'src', '#left-video');
                            rightBox.setAttribute('material', 'src', '#right-video');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error accessing media devices:', error);
                });
        });
    </script>
</body>
</html>
