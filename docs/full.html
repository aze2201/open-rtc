<!DOCTYPE html>
<html>
<head>
    <title>VR WebRTC AR</title>
    <style>
        /* VR split-screen styling */
        .vr-container {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        .eye-view {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        .video-background {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        .webrtc-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1; /* Ensure it's above the A-Scene */
        }
        .webrtc-video {
            width: 320px; /* Initial size */
            height: 240px; /* Initial size */
        }
        /* Print styling */
        @media print {
            .vr-container { flex-direction: column; }
            .eye-view { height: 50vh !important; }
        }
    </style>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="vr-container">
        <div class="eye-view">
            <video class="video-background" id="left-video" autoplay playsinline muted></video>
            <a-scene embedded>
                <a-box id="left-box" position="0 1.6 -5" width="3" height="3"></a-box>
                <a-camera position="-0.1 1.6 0"></a-camera>
                <a-sky color="#ECECEC"></a-sky>
            </a-scene>
            <div class="webrtc-container left-webrtc">
                <video id="localVideoLeft" class="webrtc-video" autoplay playsinline muted></video>
                <video id="remoteVideoLeft" class="webrtc-video" autoplay playsinline></video>
            </div>
        </div>

        <div class="eye-view">
            <video class="video-background" id="right-video" autoplay playsinline muted></video>
            <a-scene embedded>
                <a-box id="right-box" position="0 1.6 -5" width="3" height="3"></a-box>
                <a-camera position="0.1 1.6 0"></a-camera>
                <a-sky color="#ECECEC"></a-sky>
            </a-scene>
            <div class="webrtc-container right-webrtc">
                <video id="localVideoRight" class="webrtc-video" autoplay playsinline muted></video>
                <video id="remoteVideoRight" class="webrtc-video" autoplay playsinline></video>
            </div>
        </div>
    </div>

    <script>
        const peer = new Peer();
        let connection;
        let localStream;

        const localVideoLeft = document.getElementById('localVideoLeft');
        const remoteVideoLeft = document.getElementById('remoteVideoLeft');
        const localVideoRight = document.getElementById('localVideoRight');
        const remoteVideoRight = document.getElementById('remoteVideoRight');
        const webrtcContainers = document.querySelectorAll('.webrtc-container');
        const webrtcVideos = document.querySelectorAll('.webrtc-video');

        // Function to set the video stream to the video elements
        function setVideoStream(element, stream) {
            element.srcObject = stream;
        }

        // Update both boxes and video sizes
        function updateSizes(width, height, depth) {
            // Update AR boxes
            ['left-box', 'right-box'].forEach(id => {
                const box = document.getElementById(id);
                box.setAttribute('width', width);
                box.setAttribute('height', height);
                box.setAttribute('depth', depth/2);
                box.setAttribute('position', `0 1.6 -${depth}`);
            });

            // Update video backgrounds
            document.querySelectorAll('.video-background').forEach(video => {
                video.style.transform = `scale(${depth/5})`;
            });
        }

        // Function to update the size of both WebRTC boxes simultaneously
        function updateWebRTCSize(width, height) {
            webrtcVideos.forEach(video => {
                video.style.width = `${width}px`;
                video.style.height = `${height}px`;
            });
        }

        // Example of how to trigger a size change (you'd likely link this to some UI element)
        // For instance, after receiving data or based on user input
        // setTimeout(() => {
        //     updateWebRTCSize(480, 360);
        // }, 5000);

        peer.on('open', peerId => {
            const urlParams = new URLSearchParams(window.location.search);
            const remoteId = urlParams.get('PeerDesktopID');

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localStream = stream;
                    // Set local video streams for both eyes
                    setVideoStream(localVideoLeft, stream);
                    setVideoStream(localVideoRight, stream);
                    document.getElementById('left-video').srcObject = stream;
                    document.getElementById('right-video').srcObject = stream;

                    if (remoteId) {
                        const call = peer.call(remoteId, stream);
                        connection = peer.connect(remoteId);

                        connection.on('data', data => {
                            const [width, height, depth] = data.split(',').map(Number);
                            if (!isNaN(width)) updateSizes(width, height, depth);
                        });

                        call.on('stream', remoteStream => {
                            // Update both remote video elements
                            setVideoStream(remoteVideoLeft, remoteStream);
                            setVideoStream(remoteVideoRight, remoteStream);

                            // Update box textures (using left video as source for both)
                            document.querySelectorAll('a-box').forEach(box => {
                                box.setAttribute('material', 'src', '#left-video');
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error accessing media devices:', error);
                });
        });
    </script>
</body>
</html>
