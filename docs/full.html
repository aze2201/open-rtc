<!DOCTYPE html>
<html>
<head>
  <title>PeerJS - VR Mode Duplicated Page</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- Include libraries -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://api.callstats.io/static/callstats.min.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/1.5.0/sha.js"></script>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      height: 100%;
    }
    /* Outer container with two identical screens side-by-side */
    #screens {
      display: flex;
      flex-direction: row;
      width: 100vw;
      height: 100vh;
    }
    .screen {
      width: 50%;
      height: 100%;
      position: relative;
    }
    /* Each A-Frame scene fills its parent screen */
    a-scene {
      width: 100%;
      height: calc(100% - 60px); /* Leave room for video container */
    }
    /* Video container styling */
    .video-container {
      width: 100%;
      height: 60px;
      text-align: center;
      background: #000;
    }
    /* Video element styling */
    video {
      max-height: 100%;
      max-width: 100%;
    }
  </style>
</head>
<body>
  <!-- Outer container: two duplicated screens -->
  <div id="screens">
    <!-- Screen copy 1 -->
    <div class="screen" id="screen1">
      <a-scene id="sceneV1" vr-mode-ui="enabled: true;" embedded arjs="trackingMethod: best; debugUIEnabled: false;">
        <!-- AR box uses the hidden video as texture -->
        <a-box id="boxV1" look-at="[gps-camera]" src="#their-videoV1" position="0 1.6 -5" width="3" height="3" depth="2"></a-box>
      </a-scene>
      <div class="video-container" id="video-containerV1">
        <video id="their-videoV1" width="320" height="240" autoplay playsinline muted></video>
      </div>
    </div>
    <!-- Screen copy 2 -->
    <div class="screen" id="screen2">
      <a-scene id="sceneV2" vr-mode-ui="enabled: true;" embedded arjs="trackingMethod: best; debugUIEnabled: false;">
        <!-- AR box uses the hidden video as texture -->
        <a-box id="boxV2" look-at="[gps-camera]" src="#their-videoV2" position="0 1.6 -5" width="3" height="3" depth="2"></a-box>
      </a-scene>
      <div class="video-container" id="video-containerV2">
        <video id="their-videoV2" width="320" height="240" autoplay playsinline muted></video>
      </div>
    </div>
  </div>

  <script>
    // Utility: Get URL parameter by name
    function getParameterByNameV(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    // Store latest received values
    let latestWidth, latestHeight, latestDistance;

    // Update both AR boxes (on both screens) with new attributes.
    function updateBoxAttributesV(newWidth, newHeight, newDistance) {
      // Save latest values so we can update later if needed.
      latestWidth = newWidth;
      latestHeight = newHeight;
      latestDistance = newDistance;
      
      const box1 = document.getElementById('boxV1');
      const box2 = document.getElementById('boxV2');
      if (box1) {
        box1.setAttribute('width', newWidth);
        box1.setAttribute('height', newHeight);
        box1.setAttribute('position', "0 1.6 -" + newDistance);
      } else {
        console.error("BoxV1 element not found.");
      }
      if (box2) {
        box2.setAttribute('width', newWidth);
        box2.setAttribute('height', newHeight);
        box2.setAttribute('position', "0 1.6 -" + newDistance);
      } else {
        console.error("BoxV2 element not found.");
      }
    }

    // When each scene is loaded, reapply the latest size values if available.
    document.getElementById('sceneV1').addEventListener('loaded', function () {
      if (latestWidth !== undefined) {
        updateBoxAttributesV(latestWidth, latestHeight, latestDistance);
      }
    });
    document.getElementById('sceneV2').addEventListener('loaded', function () {
      if (latestWidth !== undefined) {
        updateBoxAttributesV(latestWidth, latestHeight, latestDistance);
      }
    });

    // Initialize PeerJS
    const peerV = new Peer();
    peerV.on('open', (peerId) => {
      console.log('My peer ID is: ' + peerId);
    });

    // Retrieve remote peer ID from URL
    const remotePeerIdV = getParameterByNameV('PeerDesktopID');
    if (!remotePeerIdV) {
      console.error('Remote peer ID not provided in URL parameters.');
    }

    // Get video element references from both screens
    const theirVideoV1 = document.getElementById('their-videoV1');
    const theirVideoV2 = document.getElementById('their-videoV2');

    // Request access to media devices (camera & microphone)
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then((stream) => {
        // Use local stream initially for both video elements
        theirVideoV1.srcObject = stream;
        theirVideoV2.srcObject = stream;
        theirVideoV1.addEventListener('loadedmetadata', () => {
          theirVideoV1.play().catch(err => console.error("Error playing local stream on videoV1:", err));
        });
        theirVideoV2.addEventListener('loadedmetadata', () => {
          theirVideoV2.play().catch(err => console.error("Error playing local stream on videoV2:", err));
        });

        // Initiate a call to the remote peer using the local stream
        const callV = peerV.call(remotePeerIdV, stream);
        if (!callV) {
          console.error("Call could not be initiated.");
        }

        // Connect for data exchange
        const connectionV = peerV.connect(remotePeerIdV);
        connectionV.on('open', () => {
          console.log('Connected to remote peer.');
          connectionV.on('data', (data) => {
            // Expecting data as "width,height,distance"
            const parts = data.split(',');
            if (parts.length === 3) {
              const width = parseFloat(parts[0]);
              const height = parseFloat(parts[1]);
              const distance = parseFloat(parts[2]);
              console.log("Width:", width, "Height:", height, "Distance:", distance);
              updateBoxAttributesV(width, height, distance);
            } else {
              console.warn("Unexpected data format received:", data);
            }
          });
          // Send a test message once connected
          connectionV.send("I am connected from mobile.");
        });

        // When receiving the remote stream, update both video elements
        callV.on('stream', (remoteStream) => {
          theirVideoV1.srcObject = remoteStream;
          theirVideoV2.srcObject = remoteStream;
          theirVideoV1.addEventListener('loadedmetadata', () => {
            theirVideoV1.play().catch(err => console.error("Error playing remote stream on videoV1:", err));
          });
          theirVideoV2.addEventListener('loadedmetadata', () => {
            theirVideoV2.play().catch(err => console.error("Error playing remote stream on videoV2:", err));
          });
        });

        // Handle call errors
        callV.on('error', (err) => {
          console.error("Call error:", err);
        });
      })
      .catch((error) => {
        console.error('Error accessing media devices:', error);
      });
  </script>
</body>
</html>
