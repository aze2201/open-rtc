<!DOCTYPE html>
<html>
<head>
  <title>PeerJS - VR Video Chat Example</title>
  <link rel="stylesheet" href="style.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://api.callstats.io/static/callstats.min.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/1.5.0/sha.js"></script>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene id="myScene" vr-mode-ui="enabled: true;"
           renderer="logarithmicDepthBuffer: true;"
           embedded
           arjs="trackingMethod: best; debugUIEnabled: false;">
    <a-assets>
      <video id="their-video" autoplay playsinline muted></video>
    </a-assets>

    <!-- Left Eye Video Box -->
    <a-box id="box-left" look-at="[gps-camera]" src="#their-video" 
           position="-0.2 1.6 -5" width="3" height="3" depth="2"></a-box>
           
    <!-- Right Eye Video Box -->
    <a-box id="box-right" look-at="[gps-camera]" src="#their-video" 
           position="0.2 1.6 -5" width="3" height="3" depth="2"></a-box>
  </a-scene>

  <script>
    function updateBoxAttributes(newWidth, newHeight, newDistance) {
      const boxes = document.querySelectorAll('#box-left, #box-right');
      boxes.forEach(box => {
        box.setAttribute('width', newWidth);
        box.setAttribute('height', newHeight);
        const position = box.getAttribute('position');
        position.z = -newDistance; // Update distance from camera
        box.setAttribute('position', position);
      });
    }

    const peer = new Peer();

    peer.on('open', (peerId) => {
      console.log('My peer ID is: ' + peerId);
    });

    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    const remotePeerId = getParameterByName('PeerDesktopID');
    console.log('Remote Peer ID:', remotePeerId);
    if (!remotePeerId) {
      console.error("Remote Peer ID is not provided in the URL parameters.");
    }

    const theirVideo = document.getElementById('their-video');

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then((stream) => {
        theirVideo.srcObject = stream;
        theirVideo.addEventListener('loadedmetadata', () => {
          theirVideo.play().catch(e => console.error("Error playing local stream:", e));
        });

        const call = peer.call(remotePeerId, stream);
        if (!call) {
          console.error("Call could not be initiated.");
        }

        const connection = peer.connect(remotePeerId);
        connection.on('open', () => {
          console.log('Connected to remote peer.');
          connection.on('data', (data) => {
            const parts = data.split(',');
            if (parts.length === 3) {
              const width = parseFloat(parts[0]);
              const height = parseFloat(parts[1]);
              const distance = parseFloat(parts[2]);
              console.log("Updating dimensions - Width:", width, "Height:", height, "Distance:", distance);
              updateBoxAttributes(width, height, distance);
            } else {
              console.warn("Unexpected data format received:", data);
            }
          });
          connection.send("Connected with dual-eye VR support");
        });

        call.on('stream', (remoteStream) => {
          theirVideo.srcObject = remoteStream;
          theirVideo.addEventListener('loadedmetadata', () => {
            theirVideo.play().catch(e => console.error("Error playing remote stream:", e));
          });
        });

        call.on('error', (err) => {
          console.error("Call error:", err);
        });
      })
      .catch((error) => {
        console.error('Error accessing media devices:', error);
      });
  </script>
</body>
</html>
