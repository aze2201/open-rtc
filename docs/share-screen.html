<!DOCTYPE html>
<html>
<head>
  <title>AR Video Frame 1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene 
    id="scene1"
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; debugUIEnabled: false;"
    renderer="logarithmicDepthBuffer: true;"
  >
    <a-box
      id="mainBox"
      position="0 1.6 -5"
      width="3"
      height="3"
      depth="0.1"
      material="side: double; src: #videoSource; transparent: true"
      look-at="[camera]"
    ></a-box>
    <a-camera gps-camera rotation-reader></a-camera>
  </a-scene>

  <video id="videoSource" autoplay playsinline muted style="display: none;"></video>

  <script>
    (function() {
      // Unique namespace for this frame
      const APP = {
        peer: null,
        conn: null,
        call: null,
        
        init: function() {
          this.createPeer();
          this.setupVideo();
          this.setupEventListeners();
        },
        
        createPeer: function() {
          this.peer = new Peer({
            config: {'iceServers': [{urls: 'stun:stun.l.google.com:19302'}]}
          });
          
          this.peer.on('open', id => {
            console.log('Frame1 Peer ID:', id);
            this.connectToRemote();
          });
        },
        
        setupVideo: function() {
          this.videoElement = document.getElementById('videoSource');
          this.boxElement = document.getElementById('mainBox');
        },
        
        connectToRemote: function() {
          const params = new URLSearchParams(window.location.search);
          const remoteId = params.get('PeerDesktopID');
          
          this.conn = this.peer.connect(remoteId);
          this.conn.on('open', () => {
            this.conn.on('data', data => this.handleData(data));
            this.initiateCall(remoteId);
          });
        },
        
        initiateCall: function(remoteId) {
          navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
              this.videoElement.srcObject = stream;
              this.call = this.peer.call(remoteId, stream);
              this.setupCallHandlers();
            })
            .catch(console.error);
        },
        
        setupCallHandlers: function() {
          this.call.on('stream', remoteStream => {
            this.videoElement.srcObject = remoteStream;
            this.updateVideoTexture();
          });
          
          this.call.on('error', console.error);
        },
        
        handleData: function(data) {
          const [width, height, distance] = data.split(',').map(Number);
          if (!isNaN(width) && !isNaN(height) && !isNaN(distance)) {
            this.updateBoxDimensions(width, height, distance);
          }
        },
        
        updateBoxDimensions: function(w, h, d) {
          this.boxElement.setAttribute('width', w);
          this.boxElement.setAttribute('height', h);
          this.boxElement.setAttribute('position', `0 1.6 -${d}`);
          this.updateVideoTexture();
        },
        
        updateVideoTexture: function() {
          this.boxElement.setAttribute('material', 'src', '#videoSource');
          this.boxElement.emit('componentchanged');
        }
      };

      APP.init();
    })();
  </script>
</body>
</html>
