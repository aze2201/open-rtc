<!DOCTYPE html>
<html>
<head>
  <title>PeerJS - Video Chat Example</title>
  <link rel="stylesheet" href="style.css">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
  <script src="https://api.callstats.io/static/callstats.min.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/1.5.0/sha.js"></script>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <a-scene id="myScene" vr-mode-ui="enabled: true;"
           renderer="logarithmicDepthBuffer: true;"
           embedded
           arjs="trackingMethod: best; debugUIEnabled: false;">
    <a-box id="box" look-at="[gps-camera]" src="#their-video" position="0 1.6 -5" width="3" height="3" depth="2"></a-box>
  </a-scene>

  <div class="pure-u-2-3" id="video-container">
    <video id="their-video" width="2" height="2" autoplay playsinline muted></video>
  </div>

  <script>
    (function() { // Encapsulate in IIFE to prevent global scope pollution
      function updateBoxAttributes(newWidth, newHeight, newDistance) {
        const boxElement = document.querySelector('#box');
        if (boxElement) {
          boxElement.setAttribute('width', newWidth);
          boxElement.setAttribute('height', newHeight);
          boxElement.setAttribute('position', `0 1.6 -${newDistance}`);
        }
      }

      const peer = new Peer();

      peer.on('open', (peerId) => {
        console.log('My peer ID is:', peerId);
      });

      function getParameterByName(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      const remotePeerId = getParameterByName('PeerDesktopID');
      if (!remotePeerId) console.error("Remote Peer ID missing");

      const theirVideo = document.getElementById('their-video');

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then((stream) => {
          theirVideo.srcObject = stream;
          theirVideo.play().catch(console.error);

          const call = peer.call(remotePeerId, stream);
          if (!call) console.error("Call failed");

          const conn = peer.connect(remotePeerId);
          conn.on('open', () => {
            conn.on('data', (data) => {
              const [width, height, distance] = data.split(',').map(Number);
              if (width && height && distance) {
                updateBoxAttributes(width, height, distance);
              }
            });
          });

          call.on('stream', (remoteStream) => {
            theirVideo.srcObject = remoteStream;
            theirVideo.play().catch(console.error);
          });

          call.on('error', console.error);
        })
        .catch(console.error);
    })();
  </script>
</body>
</html>
